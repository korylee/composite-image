var I=Object.defineProperty;var _=(l,a,f)=>a in l?I(l,a,{enumerable:!0,configurable:!0,writable:!0,value:f}):l[a]=f;var g=(l,a,f)=>(_(l,typeof a!="symbol"?a+"":a,f),f);(function(l,a){typeof exports=="object"&&typeof module!="undefined"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(l=typeof globalThis!="undefined"?globalThis:l||self,a(l["@korylee/composite-image"]={}))})(this,function(l){"use strict";const a=s=>typeof s=="function",f="center",T="upperLeft",p="upperRight",b="lowerLeft",L="lowerRight";function k(s){const t=new window.Image;return t.setAttribute("crossOrigin","Anonymous"),t.src=s+"?_t="+Date.now(),new Promise(i=>{t.onload=function(){return i(t)},t.onerror=function(){return i(null)}})}const x={[f]:{x:(s,t,i)=>(i.textAlign="center",s.width/2),y:(s,t,i)=>(i.textBaseline="middle",s.height/2)},[T]:{x:10,y:(s,t,i,e)=>e||20},[p]:{x:(s,t)=>s.width-(t.width+10),y:(s,t,i,e)=>e||20},[b]:{x:10,y:(s,t,i,e)=>e||s.height-10},[L]:{x:(s,t)=>s.width-(t.width+10),y:(s,t,i,e)=>e||s.height-10}},P={[f]:{x:(s,t)=>(s.width-t.width)/2,y:(s,t)=>(s.height-t.height)/2},[p]:{x:(s,t)=>s.width-(t.width+10),y:10},[T]:{x:10,y:10},[b]:{x:10,y:(s,t)=>s.height-(t.height+10)},[L]:{x:(s,t)=>s.width-(t.width+10),y:(s,t)=>s.height-(t.height+10)}};function R(s){let t=s.replace("data:image/png;base64,","");const i=t.indexOf("=");t.indexOf("=")>0&&(t=t.substring(0,i));const e=t.length,o=parseInt(e-e/8*2);let c="";c=(o/1024).toFixed(2);const n=c+"",r=n.indexOf(".");return n.substr(r+1,2)==="00"?n.substring(0,r)+n.substr(r+3,2):c}const E=s=>!!(s!=null&&s.src),v=new WeakMap;class m{constructor(t={}){g(this,"canvas");g(this,"config");g(this,"elements",[]);g(this,"asynchronousLock");g(this,"lock");g(this,"lockTimes",0);if(typeof window=="undefined")throw new Error("composite image should be running browser");this.canvas=document.createElement("canvas"),this.config=t;const{bgSrc:i,bgHeight:e,bgWidth:o}=t;i&&this.composite({src:i,height:e,width:o})}openLock(){var t;this.lockTimes===1&&!this.elements.length&&((t=this.lock)==null||t.call(this)),this.lockTimes--}closeLock(){this.lockTimes===0&&(this.asynchronousLock=new Promise(t=>this.lock=t)),this.lockTimes++}composite(...t){if(t.forEach(e=>{this.elements.push(e),E(e)&&v.set(e,k(e.src))}),this.lockTimes>0)return this;const i=this.canvas.getContext("2d");return i?((async()=>{var o,c;let e;for(;e=this.elements.shift();){const{alpha:n,position:r}=e;if(i.save(),n&&(i.globalAlpha=n),this.closeLock(),E(e)){const{width:u,height:h,x:y=0,y:w=0}=e,d=await v.get(e);if(!d)continue;!this.config.bgWidth&&!this.config.bgHeight&&(this.canvas.width=this.config.bgWidth=(o=d==null?void 0:d.width)!=null?o:u,this.canvas.height=this.config.bgHeight=(c=d==null?void 0:d.height)!=null?c:h),this.addImage(i,{x:y,y:w,position:r,image:d,width:u,height:h})}else this.addText(i,e);this.openLock(),i.restore()}})(),this):this}getTextPosition(t,{x:i=0,y:e=0,position:o,text:c,correctY:n}){const r=t.measureText(c),u=(h,y)=>a(h)?h(this.canvas,r,t,y):h;if(o){const h=x[o];h&&({x:i,y:e}=h)}return{x:u(i),y:u(e,n)}}getImagePosition(t,{x:i=0,y:e=0,position:o,image:c}){const n=r=>a(r)?r(this.canvas,c):r;if(o){const r=P[o];r&&({x:i,y:e}=r)}return{x:n(i),y:n(e)}}addImage(t,{x:i,y:e,position:o,image:c,width:n,height:r}){const u=a(n)?n(this.canvas,c):n!=null?n:c.width,h=a(r)?r(this.canvas,c):n!=null?n:c.height;c.width=u,c.height=h;const{x:y,y:w}=this.getImagePosition(t,{x:i,y:e,position:o,image:c});t.fillStyle="rgba(255, 255, 255, 0)",t.fillRect(y,w,u,h),t.drawImage(c,y,w,u,h)}addText(t,{font:i="STXihei",color:e="#000000",textBaseline:o,textAlign:c,position:n,text:r,correctY:u,x:h,y}){t.font=i,t.fillStyle=e,o&&(t.textBaseline=o),c&&(t.textAlign=c);const{x:w,y:d}=this.getTextPosition(t,{x:h,y,position:n,text:r,correctY:u});t.fillText(r,w,d)}async print(t="png",i){await this.asynchronousLock;const{base64:e,quality:o}=await this.getQuality(i);return e||this.canvas.toDataURL(t,o)}async getQuality(t){let i="";switch(t){case!0:{i=await this.print();const e=parseInt(R(i));return e<300?{base64:i}:e<1024?{quality:.85}:e>5*1024?{quality:.92}:{quality:.52}}case!1:return{quality:void 0};default:return{quality:t}}}async download(t){await this.asynchronousLock,this.canvas.toBlob(i=>{var o;if(!i)return;const e=document.createElement("a");e.download=t||`${Date.now()}.png`,e.style.display="none",e.href=URL.createObjectURL(i),document.body.appendChild(e),e.click(),(o=document.body)==null||o.removeChild(e)})}getCanvas(){return this.canvas}}g(m,"CENTER",f),g(m,"UPPER_LEFT",T),g(m,"UPPER_RIGHT",p),g(m,"LOWER_LEFT",b),g(m,"LOWER_RIGHT",L),l.CompositeImage=m,l.default=m,l.getImage=k,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
